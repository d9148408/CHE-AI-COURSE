# [Unit 05] 應用三：製程最佳化 (Process Optimization)

**課程名稱**：化工資料科學與機器學習實務（CHE-AI-101）  
**本單元目標**：
- 理解化工製程中常見的「利潤 vs 安全 vs 成本」權衡問題  
- 能把物理模型與經濟模型結合成一個「目標函數」  
- 使用 SciPy 的數值優化工具尋找最佳操作條件（溫度 T、流量 F）  
- **深入解析**：學會解讀最佳解所在的「利潤山」形狀與物理意義  
- 為後續更進階的最佳化與控制奠定直覺基礎

---

## 1. 工程師每天面對的「權衡」(Trade-off)

在實際工廠裡，工程師不會只追求「轉化率越高越好」或「產率越高越好」，因為這往往伴隨：

- **原料成本上升**：為了高產率可能需要過量的反應物。
- **能源消耗增加**：為了高反應速率需要高溫高壓。
- **設備限制**：泵浦能力、反應器耐壓都有極限。

更貼近真實的目標是：  
> 在各種限制之下 (Constraints)，找到一組操作條件 (Decision Variables)，使 **利潤 (Profit)** 最大化 (Objective Function)。

---

## 2. 理論背景與數學建模 (Theoretical Background)

為了進行最佳化，我們必須先建立描述系統行為的數學模型。本案例包含兩個層次：**物理層** (反應器行為) 與 **經濟層** (成本效益)。

### 2.1 物理層：CSTR 反應器模型

假設我們有一個連續攪拌槽反應器 (CSTR)，進行不可逆的一級反應 $A \rightarrow B$。

#### (1) 質量守恆 (Mass Balance)
對反應物 A 進行穩態 (Steady-state) 質量平衡分析：

$$
\text{Accumulation} = \text{In} - \text{Out} + \text{Generation}
$$

由於是穩態，累積項為 0；反應消耗 A，故生成項為負值：

$$
0 = F C_{A0} - F C_A - (-r_A) V
$$

其中：
- $F$：體積流率 (L/min)
- $C_{A0}$：進料濃度 (mol/L)
- $C_A$：出口濃度 (mol/L)
- $V$：反應器體積 (L)
- $-r_A$：反應速率 (mol/L·min)

#### (2) 動力學模型 (Kinetics)
對於一級反應，$-r_A = k C_A$。將其代入質量平衡方程式：

$$
0 = F C_{A0} - F C_A - k C_A V
$$

定義轉化率 $X = \frac{C_{A0} - C_A}{C_{A0}}$，則 $C_A = C_{A0}(1-X)$。
定義停留時間 $\tau = \frac{V}{F}$。

經過代數整理，我們得到 CSTR 的設計方程式：

$$
X = \frac{k \tau}{1 + k \tau}
$$

#### (3) 溫度效應 (Arrhenius Equation)
反應速率常數 $k$ 隨溫度 $T$ 變化，通常遵循 Arrhenius 方程式：

$$
k(T) = A \exp\left( \frac{-E_a}{RT} \right)
$$

在本課程的 Python 範例中，為了簡化計算並聚焦於最佳化邏輯，我們使用一個簡化的指數模型來模擬此行為：

$$
k(T) \approx 0.5 \times \exp\big(0.02 \times (T - 300)\big)
$$

這保留了「溫度越高，反應速率常數 $k$ 呈指數成長」的物理特性。

### 2.2 經濟層：目標函數 (Objective Function)

最佳化的目標是最大化利潤 (Profit)。利潤由收入減去各項成本組成：

$$
\text{Profit}(T, F) = \text{Revenue} - \text{Cost}_{\text{raw}} - \text{Cost}_{\text{energy}}
$$

各項定義如下：

1.  **收入 (Revenue)**：
    $$
    \text{Revenue} = F \times C_{A0} \times X \times P_{\text{product}}
    $$
    (註：程式碼中簡化假設 $C_{A0}=1$，故直接寫為 $F \times X \times P$)

2.  **原料成本 (Raw Material Cost)**：
    $$
    \text{Cost}_{\text{raw}} = F \times P_{\text{raw}}
    $$
    流量越大，原料費越貴，與轉化率無關。

3.  **能源成本 (Energy Cost)**：
    加熱需要消耗能源。通常能源成本與溫差成正比，但考慮到高溫下的熱散失或加熱效率下降，我們使用非線性模型：
    $$
    \text{Cost}_{\text{energy}} = \alpha \times \max(0, T - T_{\text{amb}})^{1.5}
    $$
    這意味著溫度越高，能源成本上升得越快 (邊際成本遞增)。

---

## 3. 數值最佳化策略

我們使用 `scipy.optimize.minimize` 求解器。

### 3.1 數學轉換
標準的最佳化演算法通常是尋找「最小值 (Minimize)」。為了尋找「最大利潤」，我們將目標函數取負號：

$$
\text{Minimize } J(x) = - \text{Profit}(T, F)
$$

### 3.2 限制條件 (Constraints & Bounds)
製程操作不可能無限上綱，必須設定邊界 (Bounds)：
- **溫度 T**：$300 \le T \le 400$ K (受限於加熱器能力或催化劑耐受度)
- **流量 F**：$10 \le F \le 50$ L/min (受限於泵浦規格)

---

## 4. 結果分析與視覺化 (Results & Analysis)

執行 `Part_5/Unit05_Process_Optimization.ipynb` 後，我們得到了最佳操作條件與利潤地形圖。

### 4.1 最佳化結果數據

程式輸出的最佳解顯示出高溫高流量的操作特性，其中流量觸及了設備上限：

- **最佳溫度 $T^*$ $\approx$ 370.4 K**
- **最佳流量 $F^*$ $\approx$ 50.0 L/min** (達到上限)
- **最大利潤 $\text{Profit}^*$ $\approx$ $3,352$

**數據解讀：**
1.  **溫度的權衡 (370 K)**：
    為了維持足夠的反應速率，系統選擇了較高的溫度 (370 K)。雖然這增加了能源成本，但相比於低溫導致的低轉化率，這是值得的。能源成本係數 (`cost_energy_base = 2.5`) 的設定恰好讓升溫的邊際效益在 370 K 處與邊際成本平衡，避免溫度直接衝到 400 K。
2.  **流量的權衡 (50.0 L/min)**：
    由於原料成本較低 (`cost_raw_material = 100.0`)，高產量的利潤空間很大。系統傾向於最大化流量以獲取更多產品，即使這會稍微犧牲一點轉化率。因此，流量頂到了設備的物理上限 (50 L/min)。這是一個典型的「邊界解」，暗示若能升級泵浦，利潤還有提升空間。

### 4.2 利潤等高線圖 (Contour Plot) 解析

下圖展示了 T-F 平面上的利潤分佈，顏色越亮 (黃色) 代表利潤越高，深藍色代表低利潤甚至虧損。

![利潤等高線圖](../Jupyter_Scripts/Unit05_Results/optimization_landscape.png)

**圖形詳細分析：**

1.  **紅星位置 (Optimal Point)**：
    紅星位於圖形亮黃色區域的**中心**。這是一個標準的「內點解」，表示我們成功找到了物理效率與經濟成本之間的最佳平衡點，且該點具有一定的操作彈性。

2.  **利潤山脊 (The Ridge)**：
    觀察黃色區域，呈現一條斜向的山脊。這暗示了溫度與流量的正相關性：想要處理更大的流量，就必須提高溫度來維持反應速率。

3.  **操作敏感度**：
    在紅星的右上方（更高溫、更高流速），利潤下降得非常快（顏色變深）。這提醒現場工程師：**寧可操作得保守一點（低溫低流），也不要過度操作**，因為高溫高流下的能源浪費與原料耗損會嚴重侵蝕獲利。

---

## 5. 結論

本單元展示了化工資料科學的核心精神：**「用數據與模型輔助決策」**。

我們不再依賴經驗法則 (Rule of Thumb) 盲目調整溫度或流量，而是：
1.  建立**物理模型** (描述 $T, F \rightarrow X$)。
2.  建立**經濟模型** (描述 $X \rightarrow \$$)。
3.  利用**數值演算法** (SciPy) 精確找到獲利最大的操作點。
4.  利用**視覺化** (Matplotlib) 確認操作點的穩定性與敏感度。

---

## 6. 進階議題：約束條件與靈敏度分析 (Advanced Topics)

在真實的化工廠中，最佳化問題往往比上述範例更加複雜。除了尋找最大利潤外，我們還必須滿足產品規格，並應對市場價格的波動。

### 6.1 加入品質限制 (Quality Constraints)

**理論背景：約束最佳化 (Constrained Optimization)**

單純追求利潤最大化，有時會導致產品品質下降。例如，為了追求高產量而犧牲轉化率，導致下游分離純化成本過高。因此，我們常需要在最佳化問題中加入**不等式限制 (Inequality Constraints)**。

數學形式如下 (KKT 條件的簡化應用)：
$$
\begin{aligned}
\text{Maximize} \quad & J(x) = \text{Profit}(T, F) \\
\text{Subject to} \quad & g(x) = \text{Conversion}(T, F) - 0.90 \ge 0
\end{aligned}
$$

在 `scipy.optimize.minimize` 中，這透過 `constraints` 參數實現。

**結果分析與物理意義：**

當我們強制要求 **轉化率 $X \ge 90\%$** 時，通常會觀察到以下現象：
1.  **流量 ($F$) 顯著下降**：
    回顧物理公式 $X = \frac{k \tau}{1 + k \tau}$。要提高 $X$，必須增加 $k$ (升溫) 或增加 $\tau$ (降流速)。
    由於升溫會帶來高昂的能源成本 (1.5 次方懲罰)，演算法通常會選擇**大幅降低流量**來增加停留時間 $\tau$。
2.  **利潤縮水 (Shadow Price)**：
    限制條件下的最大利潤通常低於無限制的情況。這中間的差額，就是為了達到高品質標準所付出的**隱形成本 (Shadow Price)**。這能幫助管理者評估：「追求 90% 的轉化率是否真的划算？」

### 6.2 參數靈敏度分析 (Parametric Sensitivity Analysis)

**理論背景：動態決策**

最佳操作條件 $(T^*, F^*)$ 並非一成不變，它是經濟參數 $\theta$ (如能源價格、原料成本) 的函數：
$$ (T^*, F^*) = \arg \max_{T, F} \text{Profit}(T, F; \theta) $$

**圖表分析：能源價格的影響**

下圖 (由 Notebook 生成) 展示了當**能源成本係數**從 1.0 上漲到 5.0 時，最佳操作溫度的變化軌跡：

![能源靈敏度分析](../Jupyter_Scripts/Unit05_Results/sensitivity_analysis.png)

1.  **趨勢解讀**：
    隨著能源變貴 (X 軸向右)，最佳操作溫度 $T^*$ (紅線) 呈現**非線性下降**。
2.  **操作策略地圖 (Operating Strategy Map)**：
    *   **低能源成本區**：系統傾向「高溫快炒」，維持在 380 K 以上以追求最大產能。
    *   **高能源成本區**：系統轉向「低溫慢燉」，溫度降至 340 K 左右。雖然反應變慢，但能避開昂貴的能源懲罰。
3.  **決策價值**：
    這張圖賦予了工廠**適應性 (Adaptability)**。當採購部門通知下個月電費將調漲 20% 時，生管工程師不需重新憑感覺試誤，只需查表即可知道：「我們應該將反應器溫度調降 5 度，這是目前的最佳策略。」

---

**[End of Unit 05]**
